{% extends 'base.html' %}
{% load static %}
{% load video_filters %}
{% load custom_tags %}

{% block title %}Home - BrainProject{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Hero Carousel -->
<div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">
    <div class="carousel-indicators">
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
    </div>
    <div class="carousel-inner">
        <!-- Slide 1 - Network Growth -->
        <div class="carousel-item active">
            <img src="{% static 'images/hero1.png' %}"  alt="Professional networking">
            <div class="carousel-overlay"></div>
            <div class="carousel-caption">
                <div class="animate__animated animate__fadeInDown animate__delay-1s">
                    <h6 class="text-uppercase text-warning mb-3">Elevate Your Career</h6>
                </div>
                <h1 class="display-3 fw-bold mb-4 animate__animated animate__fadeInRight animate__delay-2s">
                    <span class="text-primary">Connect</span> with Industry <span class="text-info">Leaders</span>
                </h1>
                <p class="lead mb-5 animate__animated animate__fadeInUp animate__delay-3s">
                    Join thousands of professionals expanding their networks and unlocking new opportunities
                </p>
                <div class="animate__animated animate__zoomIn animate__delay-4s">
                    <button class="btn btn-primary btn-lg px-4 py-2 me-3 shadow">
                        <i class="bi bi-people-fill me-2"></i> Join Our Network
                    </button>
                    <button class="btn btn-outline-light btn-lg px-4 py-2 shadow-sm">
                        <i class="bi bi-play-circle me-2"></i> Watch Demo
                    </button>
                </div>
            </div>
        </div>

        <!-- Slide 2 - Knowledge Sharing -->
        <div class="carousel-item">
            <img src="{% static 'images/hero2.png' %}" class="d-block w-100" alt="Knowledge sharing">
            <div class="carousel-overlay"></div>
            <div class="carousel-caption">
                <div class="animate__animated animate__fadeInDown animate__delay-1s">
                    <h6 class="text-uppercase text-info mb-3">Share Your Expertise</h6>
                </div>
                <h1 class="display-3 fw-bold mb-4 animate__animated animate__fadeInLeft animate__delay-2s">
                    <span class="text-success">Build</span> Your Professional <span class="text-warning">Brand</span>
                </h1>
                <p class="lead mb-5 animate__animated animate__fadeInUp animate__delay-3s">
                    Establish thought leadership by sharing insights with a community of ambitious professionals
                </p>
                <div class="animate__animated animate__zoomIn animate__delay-4s">
                    <button class="btn btn-success btn-lg px-4 py-2 me-3 shadow">
                        <i class="bi bi-pencil-square me-2"></i> Start Posting
                    </button>
                    <button class="btn btn-outline-light btn-lg px-4 py-2 shadow-sm">
                        <i class="bi bi-book me-2"></i> Learn How
                    </button>
                </div>
            </div>
        </div>

        <!-- Slide 3 - Opportunities -->
        <div class="carousel-item">
            <img src="{% static 'images/hero3.png' %}" class="d-block w-100" alt="Career opportunities">
            <div class="carousel-overlay"></div>
            <div class="carousel-caption">
                <div class="animate__animated animate__fadeInDown animate__delay-1s">
                    <h6 class="text-uppercase text-danger mb-3">Discover What's Next</h6>
                </div>
                <h1 class="display-3 fw-bold mb-4 animate__animated animate__fadeInRight animate__delay-2s">
                    <span class="text-warning">Find</span> Your Next <span class="text-primary">Opportunity</span>
                </h1>
                <p class="lead mb-5 animate__animated animate__fadeInUp animate__delay-3s">
                    Access exclusive jobs, projects, and collaborations tailored to your skills
                </p>
                <div class="animate__animated animate__zoomIn animate__delay-4s">
                    <button class="btn btn-warning btn-lg px-4 py-2 me-3 shadow text-white">
                        <i class="bi bi-briefcase me-2"></i> Browse Jobs
                    </button>
                    <button class="btn btn-outline-light btn-lg px-4 py-2 shadow-sm">
                        <i class="bi bi-graph-up me-2"></i> See Success Stories
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Controls -->
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
</div>

    <div class="container mt-4">
        <div class="row">
            <!-- Main Content (8 columns) -->
            <div class="col-lg-8">
                <!-- Stats Overview -->
                <div class="card mb-4 shadow-sm stats-card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col">
                                <div class="stat-value">{{ user.profile.connection_count|default:"0" }}</div>
                                <div class="stat-label">Connections</div>
                            </div>
                            <div class="col">
                                <div class="stat-value">{{ user.profile.post_count|default:"0" }}</div>
                                <div class="stat-label">Posts</div>
                            </div>
                            <div class="col">
                                <div class="stat-value">{{ user.profile.like_count|default:"0" }}</div>
                                <div class="stat-label">Likes</div>
                            </div>
                            <div class="col">
                                <div class="stat-value">{{ user.profile.comment_count|default:"0" }}</div>
                                <div class="stat-label">Comments</div>
                            </div>
                            <div class="col">
                                <div class="stat-value">{{ user.profile.impression_count|default:"0" }}</div>
                                <div class="stat-label">Impressions</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Post Card -->
                <div class="card mb-4 shadow-sm create-post-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            {% if user.profile.profile_pic %}
                                <img src="{{ user.profile.profile_pic.url }}" class="rounded-circle me-3 profile-pic-sm" alt="Profile">
                            {% else %}
                                <img src="{% static 'images/default-profile.jpg' %}" class="rounded-circle me-3 profile-pic-sm" alt="Profile">
                            {% endif %}
                            <button class="btn btn-post-trigger w-100 text-start" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                Start a post...
                            </button>
                        </div>
                        <div class="d-flex justify-content-between mt-3 post-options">
                            <button class="btn btn-option" data-type="photo">
                                <i class="bi bi-image-fill text-primary"></i> Photo
                            </button>
                            <button class="btn btn-option" data-type="video">
                                <i class="bi bi-camera-video-fill text-danger"></i> Video
                            </button>
                            <button class="btn btn-option" data-type="document">
                                <i class="bi bi-file-earmark-text-fill text-info"></i> Document
                            </button>
                            <button class="btn btn-option" data-type="poll">
                                <i class="bi bi-bar-chart-fill text-warning"></i> Poll
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div id="postsFeed">
                    {% for post in posts %}
                    {% include 'posts/post_card.html' with post=post %}
                    {% empty %}
                    <div class="card shadow-sm empty-feed">
                        <div class="card-body text-center py-5">
                            <img src="{% static 'images/empty-feed.svg' %}" alt="Empty feed" class="img-fluid mb-4">
                            <h5 class="mb-3">Your feed is empty</h5>
                            <p class="text-muted mb-4">Connect with others or create your first post to get started</p>
                            <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#createPostModal">Create Post</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center my-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar (4 columns) -->
            <div class="col-lg-4">
                <!-- Profile Summary -->
                <div class="card mb-4 shadow-sm profile-summary">
                    <div class="card-body text-center">
                        <div class="position-relative mb-3">
                            <div class="profile-cover"></div>
                            {% if user.profile.profile_pic %}
                                <img src="{{ user.profile.profile_pic.url }}" class="rounded-circle border border-4 border-white profile-img">
                            {% else %}
                                <img src="{% static 'images/default-profile.jpg' %}" class="rounded-circle border border-4 border-white profile-img">
                            {% endif %}
                        </div>
                        <h5 class="mb-1">{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted small mb-3">{{ user.profile.headline|default:"Member at BrainProject" }}</p>
                        <div class="profile-stats mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Profile views</span>
                                <strong>{{ user.profile.profile_views|default:"0" }}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Post impressions</span>
                                <strong>{{ user.profile.impression_count|default:"0" }}</strong>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="window.location='{% url 'edit_profile' request.user.username %}'">
                            <i class="bi bi-pencil-square me-1"></i> Edit Profile
                        </button>
                    </div>
                </div>
                
                <!-- Network Updates -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Network Updates</h5>
                            <a href="#" class="small">See all</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for update in network_updates %}
                            <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex align-items-start">
                                    <img src="{% if update.user.profile.profile_pic %}{{ update.user.profile.profile_pic.url }}{% else %}{% static 'images/default-profile.jpg' %}{% endif %}" 
                                         class="rounded-circle me-3" width="40" height="40">
                                    <div>
                                        <small class="d-block">
                                            <strong>{{ update.user.get_full_name|default:update.user.username }}</strong> {{ update.text }}
                                        </small>
                                        <small class="text-muted">{{ update.timestamp|timesince }} ago</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Trending Topics -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Trending in Your Network</h5>
                    </div>
                    <div class="card-body">
                        {% for topic in trending_topics %}
                        <div class="trending-topic mb-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span class="fw-bold">#{{ topic.name }}</span>
                                <span class="text-primary">{{ topic.post_count }} posts</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: {{ topic.percentage }}%;" 
                                     aria-valuenow="{{ topic.percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        {% endfor %}
                        <a href="#" class="btn btn-outline-secondary btn-sm w-100 mt-2">View all topics</a>
                    </div>
                </div>
                
                <!-- Who to Connect With -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Who to Connect With</h5>
                            <a href="#" class="small">See all</a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% for user in suggested_connections %}
                        <div class="connection-suggestion mb-3">
                            <div class="d-flex align-items-center">
                                <a href="{% url 'profile' user.username %}" class="text-decoration-none">
                                    <img src="{% if user.profile.profile_pic %}{{ user.profile.profile_pic.url }}{% else %}{% static 'images/default-profile.jpg' %}{% endif %}" 
                                         class="rounded-circle me-3" width="48" height="48">
                                </a>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">
                                        <a href="{% url 'profile' user.username %}" class="text-decoration-none">
                                            {{ user.get_full_name|default:user.username }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">{{ user.profile.headline|default:"Professional" }}</small>
                                    <div class="d-flex mt-1">
                                        {% with mutual_count=user.profile.get_mutual_connections_count %}
                                        {% if mutual_count > 0 %}
                                        <small class="text-muted">{{ mutual_count }} mutual connection{{ mutual_count|pluralize }}</small>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary connect-btn" 
                                        data-user-id="{{ user.id }}"
                                        data-username="{{ user.username }}">
                                    <i class="bi bi-person-plus"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Post Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">Create Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="postForm" method="post" enctype="multipart/form-data" action="{% url 'create_post_view' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if user.profile.profile_pic %}
                            <img src="{{ user.profile.profile_pic.url }}" class="rounded-circle me-3 profile-pic-md">
                        {% else %}
                            <img src="{% static 'images/default-profile.jpg' %}" class="rounded-circle me-3 profile-pic-md">
                        {% endif %}
                        <div>
                            <h6 class="mb-0">{{ user.get_full_name|default:user.username }}</h6>
                            <div class="privacy-selector">
                                <select class="form-select form-select-sm" name="privacy">
                                    <option value="public"><i class="bi bi-globe"></i> Public</option>
                                    <option value="connections">Connections Only</option>
                                    <option value="private">Private</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <textarea class="form-control post-content" name="content" rows="5" placeholder="What's on your mind?" required></textarea>
                    </div>
                    
                    <!-- Media Preview -->
                    <div id="mediaPreview" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span id="fileName"></span>
                                    <button type="button" class="btn-close" id="removeMedia"></button>
                                </div>
                                <div id="previewContainer" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Post Options -->
                    <div class="d-flex justify-content-between mb-3">
                        <div class="d-flex flex-wrap">
                            <label class="btn btn-sm btn-outline-secondary me-2 mb-2">
                                <i class="bi bi-image"></i> Photo
                                <input type="file" name="image" accept="image/*" class="d-none" id="imageUpload">
                            </label>
                            <label class="btn btn-sm btn-outline-secondary me-2 mb-2">
                                <i class="bi bi-camera-video"></i> Video
                                <input type="file" name="video" accept="video/*" class="d-none" id="videoUpload">
                            </label>
                            <label class="btn btn-sm btn-outline-secondary me-2 mb-2">
                                <i class="bi bi-file-earmark-text"></i> Document
                                <input type="file" name="document" accept=".pdf,.doc,.docx,.ppt,.pptx" class="d-none" id="documentUpload">
                            </label>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 mb-2" id="addPollBtn">
                                <i class="bi bi-bar-chart"></i> Poll
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addLinkBtn">
                                <i class="bi bi-link-45deg"></i> Link
                            </button>
                        </div>
                    </div>
                    
                    <!-- Poll Container (Hidden by default) -->
                    <div id="pollContainer" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control mb-2" name="poll_question" placeholder="Ask a question">
                                    <div id="pollOptions">
                                        <input type="text" class="form-control mb-2" name="poll_option1" placeholder="Option 1">
                                        <input type="text" class="form-control mb-2" name="poll_option2" placeholder="Option 2">
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addPollOption">Add Option</button>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" name="poll_multiple" id="pollMultiple">
                                        <label class="form-check-label" for="pollMultiple">Allow multiple selections</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Link Preview Container (Hidden by default) -->
                    <div id="linkPreviewContainer" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-body">
                                <input type="url" class="form-control mb-2" name="link_url" placeholder="Paste a link">
                                <div id="linkPreview"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="postSubmitBtn">Post</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Post Interaction Modal -->
<div class="modal fade" id="postInteractionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <div class="list-group list-group-flush">
                    <button type="button" class="list-group-item list-group-item-action" data-action="save">
                        <i class="bi bi-bookmark me-2"></i> Save post
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" data-action="report">
                        <i class="bi bi-flag me-2"></i> Report post
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" data-action="turn-off">
                        <i class="bi bi-bell-slash me-2"></i> Turn off notifications
                    </button>
                    {% if user == post.author.user %}
                    <button type="button" class="list-group-item list-group-item-action text-danger" data-action="delete">
                        <i class="bi bi-trash me-2"></i> Delete post
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/home.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
{% endblock %}